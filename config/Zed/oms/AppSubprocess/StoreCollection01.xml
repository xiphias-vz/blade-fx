<?xml version="1.0"?>
<statemachine
        xmlns="spryker:oms-01"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="spryker:oms-01 http://static.spryker.com/oms-01.xsd">

    <process name="Collection01">
        <states>
            <state name="collection process">
                <flag>shipped mail awaits</flag>
            </state>
            <state name="shipped mail sending" />
            <state name="shipped mail sent" />
            <state name="ready for collection" />
            <state name="collected by customer" />
            <state name="collection cancelled by customer" >
                <flag>cancelled</flag>
            </state>
            <state name="collection cancelled by store" >
                <flag>cancelled</flag>
            </state>

            <!-- Move to sub-process and make it automatic? -->
            <state name="cashier order exporting"/>
            <state name="cashier order exporting fail"/>
            <state name="cashier order exported"/>
            <!-- -->
        </states>

        <transitions>
            <transition condition="is order in shipped mail awaits">
                <source>collection process</source>
                <target>shipped mail sending</target>
            </transition>

            <transition happy="true">
                <source>shipped mail sending</source>
                <target>shipped mail sent</target>
                <event>send shipped mail</event>
            </transition>

            <transition happy="true">
                <source>shipped mail sent</source>
                <target>ready for collection</target>
                <event>move to ready for collection</event>
            </transition>

            <!-- Move to sub-process and make it automatic? -->
            <transition>
                <source>ready for collection</source>
                <target>cashier order exporting</target>
                <event>export cashier order</event>
            </transition>

            <transition happy="true" condition="is order exported to cashier">
                <source>cashier order exporting</source>
                <target>cashier order exported</target>
                <event>pass</event>
            </transition>

            <transition happy="true">
                <source>cashier order exported</source>
                <target>collected by customer</target>
                <event>confirm collection</event>
            </transition>

            <transition>
                <source>cashier order exporting</source>
                <target>cashier order exporting fail</target>
                <event>pass</event>
            </transition>

            <transition>
                <source>cashier order exporting fail</source>
                <target>ready for collection</target>
                <event>cashier order export retry</event>
            </transition>
            <!-- END of cashier section-->

            <transition happy="true">
                <source>ready for collection</source>
                <target>collected by customer</target>
                <event>confirm collection</event>
            </transition>

            <transition>
                <source>ready for collection</source>
                <target>collection cancelled by customer</target>
                <event>cancel collection by customer</event>
            </transition>

            <transition>
                <source>ready for collection</source>
                <target>collection cancelled by store</target>
                <event>cancel collection by store</event>
            </transition>

            <transition>
                <source>collection cancelled by store</source>
                <target>cancellation process</target>
                <event>process collection cancelled by store</event>
            </transition>

            <transition>
                <source>collection cancelled by customer</source>
                <target>cancellation process</target>
                <event>process collection cancelled by customer</event>
            </transition>
        </transitions>

        <events>
            <event name="send shipped mail" onEnter="true" command="Oms/SendOrderShipped"/>
            <event name="move to ready for collection" onEnter="true" command="Sales/MoveToReadyForCollection"/>
            <event name="confirm collection" manual="true" command="Sales/ConfirmCollection"/>
            <event name="cancel collection by customer" manual="true"/>
            <event name="process collection cancelled by customer" onEnter="true" command="Oms/CancelCollectionByCustomer"/>
            <event name="cancel collection by store" manual="true"/>
            <event name="process collection cancelled by store" onEnter="true" command="Oms/CancelCollectionByStore"/>

            <event name="export cashier order" manual="true" command="CashierOrderExport/OrderExport"/>
            <event name="cashier order export retry" manual="true"/>
        </events>
    </process>
</statemachine>
