{% extends model('component') %}

{% define config = {
    name: 'cart-summary'
} %}

{% define data = {
    cart: required,
    isQuoteValid: required,
    isQuoteEditable: required,
    isHardThresholdReached: required,
    isHardMaxThresholdReached: required,
    taxPayments: required,
} %}

{% set canProceedToCheckout = data.cart.items is not empty
    and data.isQuoteValid
    and (not is_granted('IS_AUTHENTICATED_FULLY') or can('WriteSharedCartPermissionPlugin', data.cart.idQuote))
    and not data.isHardThresholdReached and not data.isHardMaxThresholdReached
%}

{% block body %}
    <div class="{{ config.name }}__inner">
        <ul class="{{ config.name }}__list spacing-y spacing-y--big">
            {% if data.cart.shipment is not empty and data.cart.shipment.method is not empty %}
                <li class="{{ config.name }}__item spacing-y spacing-y--big">
                    <strong>{{ 'cart.shipping' | trans }}</strong>
                    {{ data.cart.shipment.method.name }}
                    <span class="float-right">{{ data.cart.shipment.method.storeCurrencyPrice | money }}</span>
                </li>
            {% endif %}
            <li class="{{ config.name }}__item spacing-y spacing-y--big">
                {{ 'cart.price.subtotal' | trans }}
                <span class="float-right">{{ data.cart.totals.subtotal | money }}</span>
            </li>

            {% if data.cart.totals.sumOptions %}
            <li class="{{ config.name }}__item spacing-y spacing-y--big">
                {{ 'cart.price.deposit' | trans }}
                <span class="float-right">{{ data.cart.totals.sumOptions | money }}</span>
            </li>
            {% endif %}

            {% for rate,taxItem in data.taxPayments if taxItem.tax > 0 %}
            <li class="{{ config.name }}__item spacing-y spacing-y--big">
                {{ 'cart.total.tax_total' | trans }} {{ rate / 100 }}%
                <span class="float-right">{{ taxItem.tax | money }}</span>
            </li>
            {% endfor %}

            {% for expense in data.cart.expenses if expense.type == 'THRESHOLD_EXPENSE_TYPE' %}
                <li class="{{ config.name }}__item spacing-y spacing-y--big">
                    {{ 'sales-order-threshold.strategy.soft-minimum-threshold-fixed-fee' | trans }}
                    <span class="float-right">{{ expense.sumPrice | money }}</span>
                </li>
            {% endfor %}

            {% widget 'DiscountVoucherFormWidget' only %}
                {% block body %}
                    {{ parent() }}
                    <hr>
                {% endblock %}
            {% endwidget %}

            
            {% include molecule('cart-discount-summary', 'DiscountWidget') ignore missing with {
                class: config.name ~ '__item spacing-y spacing-y--big',
                data: {
                    voucherDiscounts: data.cart.voucherDiscounts,
                    ruleDiscounts: data.cart.cartRuleDiscounts,
                    discountTotal: data.cart.totals.discounttotal,
                    isQuoteEditable: data.isQuoteEditable,
                },
            } only %}

            <li class="{{ config.name }}__item {{ config.name }}__total spacing-y spacing-y--big">
                <strong>{{ 'cart.price.grand.total' | trans }}</strong>
                <strong class="float-right">{{ data.cart.totals.grandTotal | money }}</strong>
            </li>
        </ul>
        <div class="{{ config.name }}__vat">
            {{ 'cart.include_vat' | trans }}
        </div>
    </div>

    {% if canProceedToCheckout %}
        <a class="button button--expand" href="javascript:void(0)"
           onclick="beginCheckout('{{ url('checkout-index') }}')"
           {{ qa('cart-go-to-checkout') }}>
            {{ 'cart.checkout' | trans }}
        </a>
    {% endif %}
{% endblock %}
