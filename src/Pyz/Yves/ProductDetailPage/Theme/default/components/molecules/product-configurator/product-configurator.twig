{% extends model('component') %}

{% define config = {
    name: 'product-configurator',
    tag: 'section'
} %}

{% define data = {
    product: required,
    maxQuantity: 20,
    depositPrice: null,
    tags: [],
    preisProKg: null,
    currencySymbol: app.currentCurrencySymbol,
} %}

{% set options = [] %}
{% set productName = data.product.name | default %}
{% set sku = data.product.sku %}
{% set idProductAbstract = data.product.idProductAbstract %}
{% set availabilityWidget = '' %}
{% set isProductConcrete = data.product.idProductConcrete is not empty %}
{% set isDisabled = data.product.idProductConcrete is empty or data.product.price is empty %}
{% set isProductAvailable = true %}

{% for index in 1..data.maxQuantity %}
    {% set options = options | merge([{
        label: index,
        value: index
    }]) %}
{% endfor %}

{% set isAvailable = data.product.idProductConcrete and data.product.available %}
{% set isDisabled = not isAvailable or isDisabled %}

{% set productDiscontinuedNoteWidget = findWidget('ProductDiscontinuedNoteWidget', [sku]) %}
{% if productDiscontinuedNoteWidget.isDiscontinued is not null %}
    {% set isDisabled = productDiscontinuedNoteWidget.isDiscontinued or isDisabled %}
    {% set isProductAvailable = not productDiscontinuedNoteWidget.isDiscontinued %}
{% endif %}

{% set productSaleUnit = data.product.attributes['verpackungseinheit'] | default(null) %}
{% set productSaleVolume = data.product.attributes['grundpreisinhalt'] | default(null) %}

{% block body %}
    <script type="text/javascript">
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event':'eec.PDP',
                'ecommerce':
                    {
                        'detail':
                            {
                                'products':[{
                                    'name': '{{ data.product.name }}',
                                    'id': '{{ data.product.idProductAbstract }}',
                                    'sku': '{{ data.product.sku }}',
                                    'price': '{{ data.product.prices.DEFAULT is not defined ? null : data.product.prices.DEFAULT /100}}',
                                    'list': 'PDP',
                                }],
                            },
                    }
            });
    </script>
    {% if  data.product.attributes['supplier']  is defined %}
        {% if data.product.attributes['supplier'] != 'keine Marke' and data.product.attributes['supplier']  != 'keine' and data.product.attributes['supplier']  != ''%}
            <span class="brand-text">{{ 'product.attribute.manufacturer_name' | trans}}: </span>
            <span>
                {{ data.product.attributes['supplier'] }}
            </span>
        {% endif %}
    {% endif %}

    {% if app.currentCodeBucket == 'DE' %}
        <h2 class="title title--product">
            {{ productName }}
            {% if data.product.attributes.einzelgewicht is defined %}
                -
                ca.
                {{ data.product.attributes.einzelgewicht|replace('.', ',') }}
            {% else %}
                {{ (productSaleVolume|round(3, 'floor') > 0 ? ' - ' ~ productSaleVolume|round(3, 'floor')|replace('.', ',') : '' ) }}
            {% endif %}
            {% if data.product.attributes["grundpreismasseinheit"] is defined %}
                {{ (productSaleVolume|round(3, 'floor') > 0 ? data.product.attributes["grundpreismasseinheit"] : '' ) }}
            {% endif %}
        </h2>
    {% else %}
        <h2 class="title title--product">
            {{ productName }}
            {% if data.product.attributes.einzelgewicht is defined %}
                -
                cca
                {{ data.product.attributes.einzelgewicht|replace('.', ',') }}
                {% if data.product.attributes["grundpreismasseinheit"] is defined %}
                    {{ (productSaleVolume|round(3, 'floor') > 0 ? data.product.attributes["grundpreismasseinheit"] : '' ) }}
                {% endif %}
            {% endif %}
        </h2>
    {% endif %}

    <div class="{{ config.name }}__info">
        {% if data.product.attributes['herkunftsland_o_g'] is defined %}
            <p><strong>{{ 'product.info.additional.origin.country' | trans }}: </strong>
                {% set herkunftsland = data.product.attributes['herkunftsland_o_g']|split(';') %}
                {% for key,land in herkunftsland %}
                    {% if key ==  herkunftsland|length - 1 %}
                        <span>{{ land }}</span>
                        {% else %}
                        <span>{{ land }},</span>
                     {% endif %}
                {% endfor %}
            </p>
        {% endif %}
        <div class="align-right">
            {% if not isAvailable %}

                {% else %}
                    {% set pefix = null %}
                    {% if app.currentCodeBucket == 'CZ' %}
                        {% if data.preisProKg is defined %}
                            {% if data.product.attributes.einzelgewicht is defined %}
                                {% set pefix = 'cca ' %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    {% widget 'ProductPriceVolumeWidget' args [data.product] only %}
                    {% nowidget %}
                        {% include molecule('money-price') with {
                            modifiers: ['pdp'],
                            data: {
                                amount: data.product.price,
                                prefix: pefix,
                                originalAmount: data.product.prices.ORIGINAL is not defined ? null : data.product.prices.ORIGINAL,
                            }
                        } only %}
                    {% endwidget %}
        </div>

        <div class="grid">
            {% if productSaleVolume > 0 %}
            <div class="text-secondary">
                {% if data.product.attributes.grundeinheit is defined %}
                    {% if data.preisProKg is not null and data.product.attributes.grundeinheit > 0 %}
                        {{(data.preisProKg / 100 ) | round(2, 'common') | replace('.', ',') }} {{ data.currencySymbol }}/{{ data.product.attributes.grundpreismasseinheit }}
                    {% elseif data.preisProKg is null and data.product.attributes.grundeinheit == 0 %}

                    {% else %}
                        {% if app.currentCodeBucket == 'CZ' %}
                            {{ ((((data.product.price / 100) / productSaleVolume)) * data.product.attributes.grundeinheit ) | round(2, 'common') | replace('.', ',') }} {{ data.currencySymbol }}/1 {{ data.product.attributes.grundpreismasseinheit }}
                        {% else %}
                            {{ ((((data.product.price / 100) / productSaleVolume)) * data.product.attributes.grundeinheit ) | round(2, 'common') | replace('.', ',') }} {{ data.currencySymbol }}/{{ data.product.attributes.grundeinheit }} {{ data.product.attributes.grundpreismasseinheit }}
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% include molecule('variant-configurator', 'ProductDetailPage') with {
        data: {
            superAttributes: data.product.attributeMap.superAttributes,
            selectedAttributes: data.product.selectedAttributes,
            availableAttributes: data.product.availableAttributes
        }
    } only %}

    <form method="POST" action="{{ path("cart/add", {"sku": idProductAbstract}) }}">
        <input type="hidden" name="token" value="{{ csrf_token('add-to-cart') }}"/>
        {% if data.product.attributes.pfandbetrag is defined %}
            <div class="text-secondary spacing-bottom--bigger">
                {{ 'customer.order.item_price.excluding_pfand' | trans | format(data.product.attributes.pfandbetrag) }}
            </div>
        {% endif %}

        {% embed molecule('add-to-cart-button') with {
            class: 'col--lg-10',
            data: {
                product: data.product,
            },
        } only %}
        {% endembed %}
    </form>
    {% endif %}

    {% if not isAvailable and isProductConcrete %}
        <div class="not-in-stock">
            <span style="background: red; height: 1rem; width: 1rem; border-radius: 50%; float: left">  </span>
            <span class="message">
                {{ 'product.not.in.stock.message' | trans }}
        </div>

    {% elseif isProductAvailable %}
        {% include molecule('wishlist-selector-for-pdp', 'WishlistWidget') ignore missing with {
            data: {
                sku: data.product.sku,
                idProductConcrete: data.product.idProductConcrete | default
            }
        } only %}

    {% endif %}

{% endblock %}
