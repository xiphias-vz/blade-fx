{% extends model('component') %}

{% define config = {
    name: 'record-list'
} %}

{% define data = {
    properties: {
        component: '',
        record: required
    },
    products: required,
    name: data.product.name | default,
    sku: data.product.sku | default,
    url: data.product.url | default,
    image: data.product.images is defined ? data.product.images.0.externalUrlSmall | default,
    idProductAbstract: data.product.idProductAbstract | default,
    viewMode: _view.viewMode | default,
    currencySymbol: app.currentCurrencySymbol,
    currencyIsoCode: app.currentCurrencyISOCode,
    storeId: app.sapStoreId,
    noPriceText: '---',
    currencySymbol: app.currentCurrencySymbol,
    calculatedPrice: null,
    itemWeight: null,
    prefix: null,
} %}

{%- block extraClass %}{% endblock -%}

{% set productSaleUnit = data.product.attributes.grundpreismasseinheit | default(null) %}
{% set productSupplier = data.product.attributes.supplier | default(null) %}
{% set productSaleVolume = data.product.attributes.grundpreisinhalt | default(null) %}
{% set isGlobusProduction = data.product.attributes.isGlobusProduction | default(0) %}
{% set defaultImage = publicPath("images/kein_bild_vorhanden.png") %}

{% set extraClass = '' %}

{% block body %}
 <div class="grid {{ component.renderClass(config.name ~ '__container', modifiers) }}">
    <ff-record-list {{ data.properties.component|raw }} unresolved>
        {% block record %}
            <ff-record {{ data.properties.record|raw }} class="col--sm-12 col--md-4 col--lg-3 {{ config.name}}__record-item" unresolved>
                <div class="labelDiscount">
                    {{ "{{ record.geoInformation.0.geoValues.DiscountText }}" }}
                </div>
           {% set sku %}
                {% verbatim %}
                    {{ record.MasterArticleNumber }}
                {% endverbatim %}
            {% endset %}
            {% set productName %}
                {% verbatim %}
                    {{ record.Title }}
                {% endverbatim %}
            {% endset %}
            {% set description %}
                {% verbatim %}
                    {{ record.Description }}
                {% endverbatim %}
            {% endset %}
            {% set brand %}
                {% verbatim %}
                    {{ record.Brand }}
                {% endverbatim %}
            {% endset %}
            {% set productUrl %}
                {% verbatim %}
                    {{ record.ProductUrl }}
                {% endverbatim %}
            {% endset %}
            {% set imageName %}
                {% verbatim %}
                    {{ record.ImageName }}
                {% endverbatim %}
            {% endset %}
            {% set imageUrl %}
                {% verbatim %}
                    {{ record.ImageUrl }}
                {% endverbatim %}
            {% endset %}
            {% set categoryPath %}
                {% verbatim %}
                    {{ record.CategoryPath }}
                {% endverbatim %}
            {% endset %}
            {% set sapNumber %}
                {% verbatim %}
                    {{ record.SapNumber }}
                {% endverbatim %}
            {% endset %}
                {% set idProductAbstractRecord %}
                    {% verbatim %}
                        {{ record.IdProductAbstract }}
                    {% endverbatim %}
                {% endset %}

                {% set imageExtraClasses %}
                    {% verbatim %}
                        js-image-animation__image-{{ record.IdProductAbstract }}
                    {% endverbatim %}
                {% endset %}

                {% set price %}
                {% verbatim %}
                    {{ record.geoInformation.0.geoValues.Price }}
                {% endverbatim %}
            {% endset %}

            {% set pricePerWeight %}
                {% verbatim %}
                    {{ record.record.geoInformation.0.geoValues.BasePrice }}
                {% endverbatim %}
            {% endset %}

            {% set isGlobusProduction %}
                {% verbatim %}
                    {{ record.isGlobusProduction }}
                {% endverbatim %}
            {% endset %}
            {% if isGlobusProduction is not defined or isGlobusProduction | length == 0 %}
                {% set isGlobusProduction = true %}
            {% endif %}
            {% set bioCertificationCode %}
                {% verbatim %}
                    {{ record.bioCertificationCode }}
                {% endverbatim %}
            {% endset %}

            {% set popNameExtension %}
                {% verbatim %}
                    {{ record.popNameExtension }}
                {% endverbatim %}
            {% endset %}

            {% verbatim %}
                <a href="{{ record.ProductUrl }}" style="text-decoration: none;">
                <div data-redirect="{{ record.ProductUrl }}"
                    data-redirect-target="_self">
            {% endverbatim %}

                <div class="{{ config.name }}__record-product-container">
                    {% block imageContainer %}
                        <div class="col--lg-12 col--md-12 col--sm-3 {{ config.name }}__image-wrap" onclick="productClicked('{{ productUrl }}', '{{ sku }}', '{{ productName | escape('js') }}', '{{ price }}', '{{ sku }}' )">
                            {% set splitUrl = imageUrl | split('.com/') %}
                            {% set newSrc = splitUrl[0] ~ '.com/thumb_'  ~ splitUrl[1] | default("") %}
                            <img onerror="OnErrorChangeImage(this);" class="{{ imageExtraClasses}}" src="{{ imageUrl }}"  data-storage="{{ imageUrl }}">
                        </div>
                    {% endblock %}

                    {% block contentContainer %}
                        <div class="col--sm-9 col--lg-12 {{ config.name }}__record-product-info">
                            <div class="{{ config.name }}__record-product-name">
                                <div>{{ brand ~ ' - ' ~ productName ~ popNameExtension }}</div>
                                <div class="{{ config.name ~ '__sale-volume' }}">{{ pricePerWeight }}</div>
                            </div>
                            <div class="{{ config.name }}__info-more">
                                {% set priceInfo %}
                                    {% verbatim %}
                                        {{ record.geoInformation.0.geoValues.BasePrice }}
                                    {% endverbatim %}
                                {% endset %}

                                {% block productDataContainer %}
                                    <div>{{ priceInfo }}</div>
                                {% endblock %}
                            </div>
                        </div>
                    {% endblock %}
                </div>

                <hr class="{{ config.name }}__divider" />
                </div>
                </a>
                <div class="{{ config.name }}__add-to-cart-btn">

                {% set amount %}
                    {% verbatim %}
                        {{ record.geoInformation.0.geoValues.Price }}
                    {% endverbatim %}
                {% endset %}

                {% set originalAmount %}
                    {% verbatim %}
                        {{ record.geoInformation.0.geoValues.PseudoPrice }}
                    {% endverbatim %}
                {% endset %}


                    {% block price %}
                    {% if data.itemWeight is not null -%}
                        {{ data.calculatedPrice }}
                    {%- else -%}
                        {% if originalAmount is not empty and originalAmount > amount -%}
                            <span class="{{ config.name }}__amount {{ config.name }}__amount--original">{{ originalAmount }}</span>
                        {%- endif -%}

                        {%- if amount is empty -%}
                            {{ data.noPriceText }}
                        {%- else -%}
                            {% if originalAmount is not empty and originalAmount > amount -%}
                                <span class="{{ component.renderClass(config.name ~ '__amount', modifiers) }} {{ config.name }}__amount-red">
                                    {{ data.prefix }}{{ amount }}
                                </span>
                            {%- else -%}
                                <span class="{{ component.renderClass(config.name ~ '__amount', modifiers) }}">
                                    {{ data.prefix }}{{ amount }}
                                </span>
                            {%- endif -%}
                        {%- endif -%}
                    {%- endif -%}

                        <script type="text/javascript">
                            function productClicked(productUrl, productId, productName, productPrice, productSku)
                            {
                                var ctrlPressed = 0;
                                if(event.ctrlKey){
                                    ctrlPressed = 1;
                                }
                                var rerouted = 0;
                                window.dataLayer = window.dataLayer || [];
                                window.dataLayer.push({
                                    'event': 'eec.productClick',
                                    'ecommerce':{
                                        'click':{
                                            'actionField': {'list':'Catalog'},
                                            'products': [{
                                                'id': productId,
                                                'name': productName,
                                                'price': productPrice,
                                                'sku': productSku,
                                            }]
                                        }
                                    },
                                    'eventCallback': function()
                                    {
                                        if(ctrlPressed == 0){
                                            rerouted = 1;
                                            document.location = productUrl;
                                        }
                                    }
                                });
                                setTimeout(function()
                                {
                                    if(rerouted==0 && ctrlPressed==0)
                                    {
                                        document.location = productUrl;
                                    }
                                },1000);
                            }
                        </script>
                    {% endblock %}
                    {% if app.currentCodeBucket == 'DE' %}
                        {% set addAjaxUrl %}
                            {% verbatim %}
                              /de/cart/add-ajax/{{ record.IdProductAbstract }}
                            {% endverbatim %}
                        {% endset %}

                        <a href="{{ addAjaxUrl|trim }}"
                           rel="nofollow"
                           onclick="productAddToCart('{{ sku }}','{{ productName }}','{{ price }}','{{ sku }}','{{ brand | escape('js') }}')"
                           class="
                                    button button--with-icon button--middle-icon button_center_align button--backgroundcolor-DE
                                    js-product-color-group__image-{{ sku }}
                                    js-image-animation__link
                                    js-ajax-add-to-cart__link
                                    myBtn
                                "
                           data-product-id="{{ idProductAbstractRecord }}"
                           data-product-sku="{{ sku }}"
                           data-product-title="{{ productName }}"
                           data-product-price="{{ price }}"
                           data-csrf-token="{{ csrf_token('add-to-cart-ajax') }}"
                        >
                            <span class="icon-basketplus"></span>
                            <div class="add-details-to-cart-text-holder">
                                {{- 'page.detail.add-to-cart' | trans -}}
                            </div>
                        </a>
                    {% endif %}
                    <div class="counter is-hidden">
                        {% if app.currentCodeBucket == 'DE' %}
                            <span class="is-hidden message item-added">
                            <span class="checkmark"></span>
                            {{ 'cart.add.item.ajax.success' | trans }}
                         </span>
                            <span class="is-hidden message item-removed">
                            <span class="checkmark"></span>
                            {{ 'cart.remove.item.ajax.success' | trans }}
                        </span>
                        {% endif %}

                        {% if app.currentCodeBucket == 'DE' %}
                           {% set changeAjaxUrl %}
                                {% verbatim %}
                                  /de/cart/change-ajax/{{ record.IdProductAbstract }}
                                {% endverbatim %}
                            {% endset %}

                            <a href="{{ changeAjaxUrl|trim }}"
                               class="
                                js-ajax-change-quantity__link
                                js-quantity-counter-product__decr"
                               data-csrf-token="{{ csrf_token('change-cart-ajax') }}"
                            >
                                -
                            </a>
                        {% endif %}

                        <input type="number" class="txt-product-quantity" min="1" max="99" value="1">
                        {% if app.currentCodeBucket == 'DE' %}
                            <a href="{{ changeAjaxUrl  }}"
                               class="
                            js-ajax-change-quantity__link
                            js-quantity-counter-product__incr"
                               data-csrf-token="{{ csrf_token('change-cart-ajax') }}"
                            >
                                +
                            </a>
                        {% endif %}
                    </div>

            </ff-record>
        {% endblock %}
    </ff-record-list>
 </div>
    <script>
        function OnErrorChangeImage(ev) {
            if(ev.src.includes("thumb_")) {
                let nonThumbImageFromStorage = ev.getAttribute("data-storage");
                nonThumbImageFromStorage = nonThumbImageFromStorage.replace("thumb_", "");
                ev.src = nonThumbImageFromStorage;
                ev.setAttribute("data-src", nonThumbImageFromStorage);
            } else {
                ev.src = '{{ defaultImage }}';
                ev.setAttribute("data-src", "{{ defaultImage }}");
            }
        }
    </script>
{% endblock %}

